$.widget("sfp.barchart",{options:{margin:20,statusColor:{auto:"#219244",idling:"#eb9934",setup:"#595858",change:"#00a0e9",alarm:"#ca1134",off:"#9e9e9f",defaultColor:"#FFFFFF"},oee:{second:"second",startDateTime:"start_date",status:"status"},tickColor:"#AAAAAA",tickWidth:1,dutyTime:"00:00",hourTxt:"시간",minTxt:"분",toolTipPosition:"up",isShowTooltip:true,isLimitMoveTooltip:false,onChangedDate:null,onClickBarChart:null,onChangedViewType:null,onChangedTooltip:null,onDrawBar:null},_oeeType:{day:{rate:24*60*60,txt:function(){this.options.hourTxt;return 24+this.options.hourTxt},getPointTimeTxt:function(c,b){var a=this._cunrrentType.rate/60/b;return this.DateUtil.DateType.Min.execute(this._convertPx(c*a+this.oeeTimeTxt[0].data("timepixel")))}},hour:{rate:60*60,txt:function(){this.options.hourTxt;return 1+this.options.hourTxt},getPointTimeTxt:function(b,a){return this._oeeType.day.getPointTimeTxt.call(this,b,a)}},min:{rate:12*60,txt:function(){this.options.hourTxt;return 12+this.options.minTxt},getPointTimeTxt:function(d,c){var b=this._cunrrentType.rate/c;var a=d*b+this.oeeTimeTxt[0].data("timepixel")*60;return this.DateUtil.DateType.Second.execute(a>=60*60*24?a%(60*60*24):a,true)}}},_cunrrentType:null,_lastData:[],_create:function(){this._setCurrentType("day");this.oeeBar=$("<div>",{"class":"sfp-oee-bar"});this.oeeBar.css({height:this.element.height()-30,width:this.element.width()-this.options.margin*2,marginLeft:this.options.margin});this.oeeTimeTick=$('<svg  xmlns="http://www.w3.org/2000/svg" height=50 width='+this.element.width()+">");this.tooltip=$("<div>",{"class":"sfp-oee-tooltip "+this.options.toolTipPosition}).append(this._tooltipHtml());this.oeeTimeTxt=[];this.element.addClass("sfp-oee").disableSelection().append(this.oeeBar).append(this.oeeTimeTick).append(this.tooltip);this._drawTimeTick();this.tooltipManager.initialize.call(this)},_refresh:function(){this._drawbar(this._lastData,this.oeeTimeTxt[0].data("timepixel"));this.tooltip.empty().append(this._tooltipHtml());this.tooltipManager.initialize.call(this)},_destroy:function(){this.oeeBar.remove();this.oeeTimeTick.remove();this.tooltip.remove();this.element.removeClass("sfp-oee-bar").enableSelection().css("background-color","transparent").empty()},_setOptions:function(){this._superApply(arguments);this._refresh()},_setOption:function(b,c){if("dutyTime"==b&&!/[0-9]{2}.[0-9]{2}.[0-9]{2}/.test(c)){return}else{if("dutyTime"==b){var d=c.split(":");var a=parseInt(d[0]);this.oeeTimeTxt[0].data("orgpixel",parseInt(d[0])*60+parseInt(d[1]));this.setStartDateTime("day")}}if(/oee|statusColor/.test(b)){c=$.extend({},this.options[b],c)}this._super(b,c)},_drawTimeTick:function(){var b=this.element.width();var e=this.element.height();var d="stroke:"+this.options.tickColor+";stroke-width:"+this.options.tickWidth;this.oeeTimeTick.append(this._makeSVG("line",{x1:this.options.margin,x2:b-this.options.margin,y1:0,y2:0,style:d}));for(var c=0;c<=24;c++){var a=this.options.margin+(b-this.options.margin*2)/24*c;this.oeeTimeTick.append(this._makeSVG("line",{x1:a,x2:a,y1:0,y2:10,style:d}));if(c%6==0){this._drawTimeTxt(a,c/6,this._createTime(a))}}this._updateTimeTxt(0,this.oeeTimeTxt[0].data("orgpixel"))},_drawTimeTxt:function(a,c,d){var e=this.options.dutyTime.split(":");var b=parseInt(e[0])+c*6;b=b>24?b%24:b;d.data("orgpixel",parseInt(e[0])*60+parseInt(e[1]));d.data("timepixel",parseInt(e[0])*60+parseInt(e[1]));this.element.append(d)},_createTime:function(a){this.oeeTimeTxt[this.oeeTimeTxt.length]=$("<time>",{"class":"sfp-oee-timetxt",text:"00:00",style:["left:",(a-18),"px;top:",(this.element.height()-10),"px;"].join("")});return this.oeeTimeTxt[this.oeeTimeTxt.length-1]},_updateTimeTxt:function(a,e){var d=this._cunrrentType.rate/60,b=this.DateUtil,c=this._convertPx;e+=e<this._getSecond(this.options.dutyTime)/60?1440:0;a=parseInt(a/d)*d+(e?e:0),d/=4;$.each(this.oeeTimeTxt,function(f,h){var g=a+f*d;h.text(b.getString(b.DateType.Min,c(g),false));h.data("timepixel",g)})},_findStartPoint:function(g,f,b,k,c,l){var e=b*60,j=0,m=this._getSecond(this.options.dutyTime),a=0;e+=(e<m?60*60*24:0);for(var d=0,h=f.length;d<h;d++){j=this._getSecond(f[d][this.options.oee.startDateTime]);j=e>j&&m>j?(j+=60*60*24):j;if(j>e){a=(j-e)/this._cunrrentType.rate*k;if(d>0){c=f[d-1][c];this._addOeeResult(l[c],j-e)}else{c="defaultColor"}return this._checkOverFirstPixel(g,c,a,k,d)}else{if(d==h-1&&j<e&&e<j+parseInt(f[d][this.options.oee.second])){a=(j+parseInt(f[d][this.options.oee.second])-e)/this._cunrrentType.rate*k;return this._checkOverFirstPixel(g,f[d][c],a,k,-1)}}}return{index:-1,pixel:a}},_checkOverFirstPixel:function(f,c,d,b,e){var a=e;if(d>b){e=-1,d=b}this._addbaritem(f,c,d,b,a);return{index:e,pixel:d}},_drawbar:function(f,c){var j=[],l=this.oeeBar.width(),m=this._getOeeTemplete(),h=0,a,n=0,d=this.options.oee.status,b=this.options.oee.second,o=this.options.oee.startDateTime;for(var e=0,k=f.length;e<k;e++){if(e==0&&(this.oeeTimeTxt[0].data("orgpixel")!=c||this.oeeTimeTxt[0].data("orgpixel")!=this._getSecond(f[e][o])/60)){var g=this._findStartPoint(j,f,c,l,d,m);h=+g.pixel;e=g.index;if(g.index<0){break}}a=(f[e][b]/this._cunrrentType.rate)*l;if(h+a>l){a=l-h;this._addOeeResult(m[f[e][d]],parseInt(a*this._cunrrentType.rate/l));this._addbaritem(j,f[e][d],a,l,e);break}n+=a;a=n-n%1;n=n-a;h+=a;if(k-1==e&&n>0){a+=1}this._addOeeResult(m[f[e][d]],f[e][b]);this._addbaritem(j,f[e][d],a,l,e)}this._bindEvent(this.oeeBar.empty().append(j.join("")).children(":not(.defaultColor)"));if(this._cunrrentType==this._oeeType.day){this._trigger("onDrawBar",null,[m])}},_bindEvent:function(a){a.on({mousemove:$.proxy(this.tooltipManager.calculatePoint,this),mouseleave:$.proxy(this.tooltipManager.hideToolTip,this),click:$.proxy(this.tooltipManager.clickPoint,this),dblclick:$.proxy(this.tooltipManager.nextProgress,this)})},_addbaritem:function(e,a,b,d,c){if(b>0){e.push('<span class="',a,'" style="width:',b,"px;background-color:",this.options.statusColor[a],'" data-index=',c,"></span>")}},_makeSVG:function(a,c){var d=document.createElementNS("http://www.w3.org/2000/svg",a);for(var b in c){d.setAttribute(b,c[b])}return d},_tooltipHtml:function(){return["<time>00:00</time>",'<button type="button" data-value="day" class="on"><span>',this._oeeType.day.txt.call(this),"</span></button>",'<button type="button" data-value="hour"><span>',this._oeeType.hour.txt.call(this),"</span></button>",'<button type="button" data-value="min"><span>',this._oeeType.min.txt.call(this),"</span></button>",'<div class="arrow">'].join("")},_addOeeResult:function(b,a){if(a>0&&b!==undefined){b.sec+=parseInt(a);b.cnt++}},_getOeeTemplete:function(){var a={};for(var b in this.options.statusColor){a[b]={sec:0,cnt:0}}return a},_setCurrentType:function(a){if(this._oeeType[a]){this._cunrrentType=this._oeeType[a]}},_pad:function(b,a){b=String(b);a=parseInt(a,10)||2;while(b.length<a){b="0"+b}return b},_convertPx:function(a){a=(a>=1440)?a%1440:a;a=(a<0)?1440+a%1440:a;return a},DateUtil:(function(){var b=":";var c={Min:{execute:function(f,g){var e=parseInt(f/60);f%=60;return[d(e,2),b,d(parseInt(f),2),(g?(b+"00"):"")].join("")}},Second:{execute:function(g,i){var f=parseInt(g/3600);g%=3600;var h=parseInt(g/60),e=parseInt(g%60);return[d(f,2),d(h,2),i?d(e,2):""].join(b)}},Hour:{execute:function(e,f){return[d(parseInt(e),2),"00",f?"00":""].join(b)}}},a=function(e,g,f){return e.execute.call(this,g,f===undefined?true:f)},d=function(f,e){f=String(f);e=parseInt(e,10)||2;while(f.length<e){f="0"+f}return f};return{DateType:c,getString:a}})(),_getdate:function(b){var a=b.match(/([0-9]{4}).([0-9]{2}).([0-9]{2}) ([0-9]{2}).([0-9]{2}).([0-9]{2})/);return a&&a.length>6?new Date(a[1],parseInt(a[2])-1,a[3],a[4],a[5],a[6]):new Date()},_getSecond:function(c){var b=c.split(/[-: ]/);var a=b.length;return b&&b.length>1?(b.length%3==0?parseInt(b[a-3])*60*60+parseInt(b[a-2])*60+parseInt(b[a-1]):parseInt(b[a-2])*60*60+parseInt(b[a-1])*60):0},_getTxt:function(b,a){return this._cunrrentType.getPointTimeTxt.call(this,b,a)},_update:function(a){this._updateTimeTxt(0,a);this._drawbar(this._lastData,a)},getTimes:function(){var b=[];for(var c=0,a=this.oeeTimeTxt.length;c<a;c++){b[b.length]=[this.oeeTimeTxt[c].text(),":00"].join("")}return b},setData:function(c,b,a){this._lastData=c;this.setStartDateTime(b,a)},setStartDateTime:function(b,a){var c=b=="day"?this.oeeTimeTxt[0].data("orgpixel"):(a!==undefined?this._getSecond(a)/60:this.oeeTimeTxt[0].data("timepixel"));this._setCurrentType(b);this._updateTimeTxt(0,c);this._drawbar(this._lastData,c)},clear:function(){this.setData([],"day",this.options.dutyTime)},next:function(){console.log(this.isNextDate());if(this.isNextDate()){if($.isFunction(this.options.onChangedDate)){if(this._trigger("onChangedDate",null,[+1])){this._updateTimeTxt(0,this.oeeTimeTxt[0].data("orgpixel"))}console.log("trigger onChangedDate  +1 day")}else{if(this._cunrrentType!=this._oeeType.day){this._update(this.oeeTimeTxt[0].data("orgpixel"))}}}else{this._update(this.oeeTimeTxt[0].data("timepixel")+this._cunrrentType.rate/60)}},isNextDate:function(){if(this._getSecond(this.options.dutyTime)/60+1440<=this.oeeTimeTxt[0].data("timepixel")+this._cunrrentType.rate/60){return true}return false},prev:function(){if(this.isPrevDate()){if($.isFunction(this.options.onChangedDate)){if(this._trigger("onChangedDate",null,[-1])){this._updateTimeTxt(0,this.oeeTimeTxt[0].data("timepixel")-this._cunrrentType.rate/60)}console.log("trigger onChangedDate  -1 day")}else{if(this._cunrrentType!=this._oeeType.day){this._update(this.oeeTimeTxt[0].data("orgpixel")+1440-this._cunrrentType.rate/60)}}}else{this._update(this.oeeTimeTxt[0].data("timepixel")-this._cunrrentType.rate/60)}},isPrevDate:function(){if(this._getSecond(this.options.dutyTime)/60>this.oeeTimeTxt[0].data("timepixel")-this._cunrrentType.rate/60){return true}return false},tooltipManager:(function(){var e=false,r=[],g,t,n,f,q,t,h,p,u,m,b,v;var c=function(){p=this,u=this.tooltip,m=u.find("time"),b=u.find("button"),v=u.find(".arrow");h=v.position().left,n=u.parent().offset().left,f=u.width(),q=f/2,t=this.oeeBar.width();u.on({mouseenter:i,mouseleave:$.proxy(o,this)});b.click($.proxy(function(C){var B=$(C.currentTarget),y=B.index()-1,z=B.data("value"),w=0,A=this._cunrrentType.rate;this._setCurrentType(z);if(z=="day"){w=this.oeeTimeTxt[0].data("orgpixel")}else{if(z=="hour"&&this._cunrrentType.rate>A){w=this.oeeTimeTxt[0].data("timepixel");w=w-(w+this.oeeTimeTxt[0].data("orgpixel"))%60}else{w=g*A/60/t;A=this._cunrrentType.rate/60;w=parseInt(w/A)*A+this.oeeTimeTxt[0].data("timepixel")}}b.removeClass("on").eq(y).addClass("on");this._update(w);this._trigger("onChangedViewType",null,[z,this.getTimes()])},this))},d=function(w){if(this.options.isLimitMoveTooltip){k(w,this.options.margin+this.options.margin)}else{u.css({left:w.clientX-n-q})}g=w.clientX-n-this.options.margin;m[0].innerHTML=this._getTxt(g,t);if(this.options.isShowTooltip&&!e){this.tooltip.show();e=true}i();this._trigger("onChangedTooltip",null,[g,m[0].innerHTML,true])},k=function(A,z){var w=A.clientX-n-q;var y=t-f+z;if(w>0){if(w<y){u.css({left:w});v.css({left:"50%"})}else{u.css({left:y});v.css({left:w-y+q})}}else{u.css({left:0});v.css({left:w+q})}},o=function(w){w.preventDefault();r[r.length]=setTimeout($.proxy(j,this),100)},i=function(y){for(var x=0,w=r.length;x<w;x++){clearTimeout(r[x])}r=[]},j=function(){u.hide();this._trigger("onChangedTooltip",null,[-1,"",false]);e=false},l=function(x){g=x.clientX-n-this.options.margin;var w=b.filter(".on").next("button");if(w.length>0){w.trigger("click")}else{b.first().trigger("click")}},a=function(w){console.dir(this._lastData.slice(1,3));this._trigger("onClickBarChart",null,[this._getTxt(g,t),$(w.target).data()])},s=function(){b.removeClass("on").eq(0).addClass("on")};return{calculatePoint:d,hideToolTip:o,cancelHideToolTip:i,nextProgress:l,clear:s,clickPoint:a,initialize:c}})()});