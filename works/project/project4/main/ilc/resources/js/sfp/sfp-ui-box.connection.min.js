$.widget("sfp.connection",{options:{lineColor:"#CDCDCD",lineWidth:1,"z-index":1},_create:function(){this.svg=$(['<svg  xmlns="http://www.w3.org/2000/svg" style="position:absolute;top:0px;left:0px;z-index:',this.options["z-index"],'" height=',this.element.height()," width=",this.element.width(),">"].join(""));this.element.prepend(this.svg);this.stack=[]},_refresh:function(){this.redraw()},redraw:function(){this.svg.empty();for(var b=0,a=this.stack.length;b<a;b++){this.drawLine(this.stack[b])}},_getPosition:function(b){var d=this.element.offset();var f=$(b);var g=f.offset().left-d.left;var e=f.offset().top-d.top;var c=f.height();var a=f.width();return{left:{x:g,y:e+c/2},right:{x:g+a,y:e+c/2},up:{x:g+a/2,y:e},down:{x:g+a/2,y:e+c}}},_getDistance:function(b,a,d,c){return Math.sqrt(Math.pow((b-a),2)+Math.pow((d-c),2))},drawLine:function(a){var c=this._getPosition(a.from);var b=["stroke:",a.lineColor?a.lineColor:this.options.lineColor,";stroke-width:",a.lineWidth?a.lineWidth:this.options.lineWidth].join("");var d=this._getPosition;$(a.to).each($.proxy(function(k,f){var h;var m;var l=9999;var i=this._getPosition(f);if(a.fromPosition){h=c[a.fromPosition];m=this._isMinDistanceTo(h,i,a)}else{for(var e in c){var j=this._isMinDistanceTo(c[e],i,a);var g=this._getDistance(c[e].x,j.x,c[e].y,j.y);if(l>g){l=g;h=c[e];m=j}}}this._drawLine(h,m,b)},this))},_drawLine:function(c,b,a){this.svg.append(this._makeSVG("line",{x1:c.x,x2:b.x,y1:c.y,y2:b.y,style:a}))},_isMinDistanceTo:function(d,g,c){var b;var f=9999;if(c.toPosition){return g[c.toPosition]}else{for(var e in g){var a=this._getDistance(d.x,g[e].x,d.y,g[e].y);if(f>a){f=a;b=g[e]}}}return b},_destroy:function(){this.svg.remove()},_setOptions:function(){this._superApply(arguments);this._refresh()},_setOption:function(a,b){if(/lineColor|lineWidth/.test(a)){b=$.extend({},this.options[a],b)}this._super(a,b)},_makeSVG:function(a,c){var d=document.createElementNS("http://www.w3.org/2000/svg",a);for(var b in c){d.setAttribute(b,c[b])}return d}});